---
title: "DM Group 19"
author: "Mina Narayanan"
date: "5/14/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggplot2)
library(ISLR)
library(MASS)
library(klaR) 
library(knitr)
library(glmnet)
library(gam)
library(plyr)
library(reshape)
```

# To filter compas two years

Subset of columns used in original analysis are:
raw_data, age, c_charge_degree, race, age_cat, score_text, sex, priors_count, days_b_screening_arrest, decile_score, is_recid, two_year_recid, c_jail_in, c_jail_out

```{r}
raw_data <- read.csv("./compas-scores-two-years.csv")
nrow(raw_data)

compas_non_violent <- raw_data %>% 
  filter(days_b_screening_arrest <= 30) %>%
  filter(days_b_screening_arrest >= -30) %>%
  filter(is_recid != -1) %>%
  filter(c_charge_degree != "O") %>%
  filter(score_text != 'N/A')
nrow(compas_non_violent)

compas_non_violent <- mutate(compas_non_violent, crime_factor = factor(c_charge_degree)) %>%
      mutate(age_factor = as.factor(age_cat)) %>%
      within(age_factor <- relevel(age_factor, ref = 1)) %>%
      mutate(race_factor = factor(race)) %>%
      within(race_factor <- relevel(race_factor, ref = 3)) %>%
      mutate(gender_factor = factor(sex, labels= c("Female","Male"))) %>%
      within(gender_factor <- relevel(gender_factor, ref = 2)) %>%
      mutate(score_factor = factor(score_text != "Low", labels = c("LowScore","HighScore")))

levels(compas_non_violent$race_factor)
levels (compas_non_violent$race)
levels(compas_non_violent$score_text)
levels(compas_non_violent$score_factor)

#compas_non_violent$race_num <- as.numeric(compas_non_violent$race)
#compas_non_violent$sex_num <- as.numeric(compas_non_violent$sex)
  
```


# LDA
```{r}
# TODO: Feature selection?

# TODO: Apply training and test ratios
index = sample( 1:nrow( compas_non_violent ), round( nrow( compas_non_violent )*0.6 ), replace = FALSE )
train = compas_non_violent[ index, ] # About 60% of the observations
test = compas_non_violent[ -index, ] # About 40% of the observations


# Nonviolent
nonviolent.lda <- lda(is_recid ~ gender_factor + age_factor + race_factor + crime_factor + priors_count + two_year_recid + juv_fel_count + juv_misd_count + juv_other_count, data=compas_non_violent)
nonviolent.lda
plot(nonviolent.lda, col=as.numeric(compas_non_violent$is_recid))

lda.probs=predict(nonviolent.lda,type="response")
ct <- table(compas_non_violent$is_recid, lda.probs$class)
ct
# Accuracy is 3987/6172 = 97.067%
# COMPAS system's concordance is 63.6%


# Violent
violent.lda <- lda(is_violent_recid ~ gender_factor + age_factor + race_factor + crime_factor + priors_count + two_year_recid + juv_fel_count + juv_misd_count + juv_other_count, data=compas_non_violent)
violent.lda
plot(violent.lda, col=as.numeric(compas_non_violent$is_violent_recid))

lda.probs=predict(violent.lda,type="response")
ct <- table(compas_non_violent$is_violent_recid, lda.probs$class)
ct
# Accuracy is 5481/6172 = 88.804%
# COMPAS's violent recidivism score has a slightly higher overall concordance score of 65.1%


```

# QDA
```{r}
# Nonviolent
nonviolent.qda <- qda(score_text ~ sex_num + age + race_num + c_charge_degree + priors_count + two_year_recid + juv_fel_count + juv_misd_count + juv_other_count, data=compas_non_violent)
nonviolent.qda
qda.probs=predict(nonviolent.qda,type="response")
ct <- table(compas_non_violent$score_text, qda.probs$class)
ct
# Accuracy is 3843/6172 = 62.265%
# COMPAS system's concordance is 63.6%

graphics.off()
par("mar")
par(mar=c(1,1,1,1))
partimat(score_text ~ sex_num + age + race_num + c_charge_degree + priors_count + two_year_recid + juv_fel_count + juv_misd_count + juv_other_count, data=compas_non_violent, method="qda", plot.matrix=TRUE)


# Violent
violent.qda <- qda(v_score_text ~ sex_num + age + race_num + c_charge_degree + priors_count + two_year_recid + juv_fel_count + juv_misd_count + juv_other_count, data=compas_non_violent)
violent.qda
qda.probs=predict(violent.qda,type="response")
ct <- table(compas_non_violent$v_score_text, qda.probs$class)
ct
# Accuracy is 4212/6172 = 68.244%
# COMPAS's violent recidivism score has a slightly higher overall concordance score of 65.1%

```

# Naive Bayes
```{r}
# Nonviolent 
nonviolent.nb <- NaiveBayes(score_text ~ sex_num + age + race_num + c_charge_degree + priors_count + two_year_recid + juv_fel_count + juv_misd_count + juv_other_count, data=compas_non_violent, usekernel=TRUE)
bayes.probs=predict(nonviolent.nb, type="response")
out <- table(compas_non_violent$score_text, bayes.probs$class)
out
# Accuracy of 3560/6127 = 58.103%
# COMPAS system's concordance is 63.6%

# Violent
violent.nb <- NaiveBayes(v_score_text ~ sex_num + age + race_num + c_charge_degree + priors_count + two_year_recid + juv_fel_count + juv_misd_count + juv_other_count, data=compas_non_violent, usekernel=TRUE)
bayes.probs=predict(violent.nb, type="response")
out <- table(compas_non_violent$v_score_text, bayes.probs$class)
out
# Accuracy of 4166/6127 = 67.994%
# COMPAS's violent recidivism score has a slightly higher overall concordance score of 65.1%
```


# RAI
```{r}
rai <- function(type=c("lda", "qda", "bayes", "rf", "dec", "reg")) {
  type <- match.arg(type)
  if (type == "lda") {
  }
}
```






